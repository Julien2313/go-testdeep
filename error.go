package testdeep

import (
	"bytes"
	"strings"
)

// Error represents errors generated by testdeep functions.
type Error struct {
	// Context when the error occurred
	Context Context
	// Message describes the error
	Message string
	// Got value
	Got interface{}
	// Expected value
	Expected interface{}
	// If not nil, Summary is used to display summary instead of using
	// Got + Expected fields
	Summary interface{}
	// If initialized, location of TestDeep operator originator of the error
	Location Location
	// If defined, the current Error comes from this Error
	Origin *Error
}

var booleanError = &Error{}

// Error implements error interface.
func (e *Error) Error() string {
	if e == booleanError {
		return ""
	}

	buf := &bytes.Buffer{}

	if pos := strings.Index(e.Message, "%%"); pos >= 0 {
		buf.WriteString(e.Message[:pos])
		buf.WriteString(e.Context.path)
		buf.WriteString(e.Message[pos+2:])
	} else {
		buf.WriteString(e.Context.path)
		buf.WriteString(": ")
		buf.WriteString(e.Message)
	}

	buf.WriteByte('\n')

	if e.Summary != nil {
		buf.WriteByte('\t')
		buf.WriteString(indentString(e.SummaryString(), "\t"))
	} else {
		buf.WriteString("\t     got: ")
		buf.WriteString(indentString(e.GotString(), "\t          "))
		buf.WriteString("\n\texpected: ")
		buf.WriteString(indentString(e.ExpectedString(), "\t          "))
	}

	if e.Location.IsInitialized() {
		if strings.HasPrefix(e.Location.Func, "Cmp") {
			buf.WriteString("\n[called by ")
		} else {
			buf.WriteString("\n[under TestDeep operator ")
		}
		buf.WriteString(e.Location.String())
		buf.WriteByte(']')
	}

	// This error comes from another one
	if e.Origin != nil {
		buf.WriteString("\nOriginates from following error:\n\t")
		buf.WriteString(indentString(e.Origin.Error(), "\t"))
	}

	return buf.String()
}

// GotString returns the string corresponding to the Got
// field. Returns the empty string if the Error Summary field is not
// empty.
func (e *Error) GotString() string {
	if e.Summary != nil {
		return ""
	}
	return toString(e.Got)
}

// ExpectedString returns the string corresponding to the Expected
// field. Returns the empty string if the Error Summary field is not
// empty.
func (e *Error) ExpectedString() string {
	if e.Summary != nil {
		return ""
	}
	return toString(e.Expected)
}

// SummaryString returns the string corresponding to the Summary
// field. Returns the empty string if the Error Summary field is nil.
func (e *Error) SummaryString() string {
	if e.Summary == nil {
		return ""
	}
	return toString(e.Summary)
}

// SetLocationIfMissing initializes the Error Location field if it not
// initialized yet, with the location of the passed TestDeep operator.
func (e *Error) SetLocationIfMissing(t TestDeep) *Error {
	if e != nil && !e.Location.IsInitialized() {
		e.Location = t.GetLocation()
	}
	return e
}
